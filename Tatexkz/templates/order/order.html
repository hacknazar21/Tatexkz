{% extends 'base.html' %}

{% block title %}Сотрудничество{% endblock %}
{% block content %}
<main class="page">
    {% if not error %}
    <section class="page__name page-name">
        <h1 class="page-name__title"><a href="/">Оформить посылку</a></h1>
    </section>
    <section class="page__order order">
        <div class="order__container">

            <h2 class="order__title title-h2">Тип посылки</h2>

            <div class="order__body">
                <form action="/payment/" method="post" class="order__form form-order">
                    {% csrf_token %}
                    <div class="order__type">
                        {% if type == 'document' %}
                        <input checked type="radio" class="form-order__type-btn button radio " id="typedocument"
                            name="type" value="document">
                        {% else %}
                        <input type="radio" class="form-order__type-btn button radio " id="typedocument" name="type"
                            value="document">
                        {% endif %}

                        <label class="form-order__label" for="typedocument">Документ</label>
                        {% if type == 'package' %}
                        <input checked type="radio" checked class="form-order__type-btn button radio " id="typepackage"
                            name="type" value="package">
                        {% else %}
                        <input type="radio" class="form-order__type-btn button radio " id="typepackage" name="type"
                            value="package">
                        {% endif %}
                        <label class="form-order__label" for="typepackage">Посылка</label>
                    </div>
                    <div data-for="document" class="form-order__body">
                        <div class="form-order__section">
                            <h2 class="form-order__title title-h2">Вес и габариты</h2>
                            <div class="form-order__grid">
                                <div class="form-order__input-box">
                                    <div class="form-order__input-title _nessesary">Вес(кг)</div>
                                    <div class="input _icon-weight">
                                        <input value="0.3" data-inputnumber required autocomplete="off" type="text" name="weight"
                                            data-error="Ошибка" data-inputmask-clearmaskonlostfocus="true"
                                            data-inputmask="'mask': '9{+|1}.9 (кг)', 'greedy' : false"
                                            placeholder="Вес (кг)" class="form-order__input" value="{{weight}}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div data-for="package" class="form-order__body">
                        <div class="form-order__alert form-alert">
                            <h3 class="form-alert__title">Список запрещенных предметов</h3>
                            <ul class="form-alert__list">
                                <li class="form-alert__item">Наркотические средства</li>
                                <li class="form-alert__item">Психотропные вещества и прекурсоры</li>
                                <li class="form-alert__item">Ядерные материалы, радиоактивные и другие опасные
                                    вещества</li>
                                <li class="form-alert__item">Яды, ядовитые животные, вещества, растения и семена.
                                </li>
                            </ul>
                        </div>
                        <div class="form-order__section">
                            <h2 class="form-order__title title-h2">Вес и габариты</h2>
                            <div class="form-order__grid">
                                <div class="form-order__input-box">
                                    <div class="form-order__input-title _nessesary">Вес(кг)</div>
                                    <div class="input _icon-weight">
                                        <input  data-inputnumber required autocomplete="off" type="text" name="weight"
                                            data-error="Ошибка" data-inputmask-clearmaskonlostfocus="true"
                                            data-inputmask="'mask': '9{+|1}.9 (кг)', 'greedy' : false"
                                            placeholder="Вес (кг)" class="form-order__input" value="{{weight}}">
                                    </div>
                                </div>
                                <div class="form-order__input-box">
                                    <div class="form-order__input-title">Длина(см)</div>
                                    <div class="input _icon-treangle">
                                        <input autocomplete="off" required data-inputmask-clearmaskonlostfocus=" true"
										data-inputmask="'mask': '9{+|1} (см)', 'greedy' : false" type="text" name="length" data-error="Ошибка"
                                            placeholder="Длина(см)" data-placeholder="Длина(см)"
                                            class="form-order__input" value="{{length}}">
                                    </div>
                                </div>
                                <div class="form-order__input-box">
                                    <div class="form-order__input-title">Ширина(см)</div>
                                    <div class="input _icon-treangle">
                                        <input autocomplete="off" required data-inputmask-clearmaskonlostfocus=" true"
										data-inputmask="'mask': '9{+|1} (см)', 'greedy' : false" type="text" name="width" data-error="Ошибка"
                                            placeholder="Ширина(см)" data-placeholder="Ширина(см)"
                                            class="form-order__input" value="{{width}}">
                                    </div>
                                </div>
                                <div class="form-order__input-box">
                                    <div class="form-order__input-title">Высота(см)</div>
                                    <div class="input _icon-treangle">
                                        <input autocomplete="off" required data-inputmask-clearmaskonlostfocus=" true"
										data-inputmask="'mask': '9{+|1} (см)', 'greedy' : false" type="text" name="height" data-error="Ошибка"
                                            placeholder="Высота(см)" data-placeholder="Высота(см)"
                                            class="form-order__input" value="{{height}}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-order__body">
                        <div class="form-order__section">
                            <h2 class="form-order__title title-h2">Заполните данные о посылке</h2>
                            <div class="form-order__grid">
                                <div class="form-order__input-box">
                                    <div class="form-order__input-title _nessesary">Страна отправителя</div>
                                    <div class="input">
                                        <select data-search required name="from_country" data-country="from" class="form"
                                            data-pseudo-label>
                                            {% if activeCountryFrom %}
                                            <option value="{{activeCountryFrom}}" selected>{{activeCountryFrom}}
                                            </option>
                                            {% else %}
                                            <option value="" selected>Страна</option>
                                            {% endif %}
                                            {% for key in countries %}
                                            <option value="{{key}}">{{key}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="form-order__input-box">
                                    <div class="form-order__input-title _nessesary">Страна получателя</div>
                                    <div class="input">
                                        <select data-search required name="where_country" data-country="where" class="form"
                                            data-pseudo-label>
                                            {% if activeCountryWhere %}
                                            <option value="{{activeCountryWhere}}" selected>{{activeCountryWhere}}
                                            </option>
                                            {% else %}
                                            <option value="" selected>Страна</option>
                                            {% endif %}
                                            {% for key in countries %}
                                            <option value="{{key}}">{{key}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="form-order__input-box">
                                    <div class="form-order__input-title _nessesary">Город отправителя</div>
                                    <div class="input">
                                        <select data-search required name="from" class="form" data-pseudo-label>
                                            {% if fromcity %}
                                            <option value="{{fromcity}}" selected>{{fromcity}}</option>
                                            {% else %}
                                            <option value="" selected>Город</option>
                                            {% endif %}
                                            {% if activeCountryFrom %}
                                            {% for city in citiesfrom %}
                                            <option value="{{city}}">{{city}}</option>
                                            {% endfor %}
                                            {% endif %}
                                        </select>
                                    </div>
                                </div>
                                <div class="form-order__input-box">
                                    <div class="form-order__input-title _nessesary">Город получателя</div>
                                    <div class="input">
                                        <select data-search required name="where" class="form" data-pseudo-label>
                                            {% if wherecity %}
                                            <option value="{{wherecity}}" selected>{{wherecity}}</option>
                                            {% else %}
                                            <option value="" selected>Город</option>
                                            {% endif %}
                                            {% if activeCountryWhere %}
                                            {% for city in citieswhere %}
                                            <option value="{{city}}">{{city}}</option>
                                            {% endfor %}
                                            {% endif %}
                                        </select>
                                    </div>
                                </div>
                                <div class="form-order__input-box">
                                    <div class="form-order__input-title _nessesary">Адрес отправителя</div>
                                    <div class="input">
                                        <input required autocomplete="off" type="text" name="sendersAddress"
                                            data-error="Ошибка" placeholder="улица, дом, офис/квартира, этаж"
                                            class="form-order__input">
                                    </div>
                                </div>
                                <div class="form-order__input-box">
                                    <div class="form-order__input-title _nessesary">Адрес получателя</div>
                                    <div class="input">
                                        <input required autocomplete="off" type="text" name="recipientAddress"
                                            data-error="Ошибка" placeholder="улица, дом, офис/квартира, этаж"
                                            class="form-order__input">
                                    </div>
                                </div>
                                <div class="form-order__input-box">
                                    <div class="form-order__input-title _nessesary">Почтовый индекс отправителя
                                    </div>
                                    <div class="input">
                                        <input data-inputmask="'mask': '999999', 'placeholder': 'x'" required
                                            autocomplete="off" type="text" name="postIndexSender" data-error="Ошибка"
                                            placeholder="Почтовый индекс" class="form-order__input">
                                    </div>
                                </div>
                                <div class="form-order__input-box">
                                    <div class="form-order__input-title _nessesary">Почтовый индекс получателя</div>
                                    <div class="input">
                                        <input data-inputmask="'mask': '999999', 'placeholder': 'x'" required
                                            autocomplete="off" type="text" name="postIndexRecipient" data-error="Ошибка"
                                            placeholder="Почтовый индекс" class="form-order__input">
                                    </div>
                                </div>
                                <div class="form-order__input-box">
                                    <div class="form-order__input-title _nessesary">Выберите дату забора</div>
                                    
                                    <div class="input">
                                        <input required autocomplete="off" type="text" name="dataSend"
                                            data-error="Ошибка" placeholder="Дата забора" id="dataSend"
                                            class="form-order__input calendar">
                                        <label for="dataSend" class="_icon-calendar"></label>
                                    </div>
                                    <div style="margin-top: 10px;" class="form-order__input-title _nessesary">После 15:30 невозможно оформить вызов курьера на текущий день</div>

                                </div>
                            </div>
                        </div>
                        <div class="form-order__section">
                            <h2 class="form-order__title title-h2">Заполните данные</h2>
                            <div class="form-order__grid">
                                <div class="form-order__input-box">
                                    <div class="form-order__input-title _nessesary">Имя отправителя</div>
                                    <div class="input">
                                        <input required autocomplete="off" type="text" name="sendersName"
                                            data-error="Ошибка" placeholder="Введите имя отправителя"
                                            class="form-order__input">
                                    </div>
                                </div>
                                <div class="form-order__input-box">
                                    <div class="form-order__input-title _nessesary">Телефон отправителя</div>
                                    <div class="input">
                                        <input required data-phone autocomplete="off" type="text" name="sendersTel"
                                            data-error="Ошибка" placeholder="Номер телефона" class="form-order__input">
                                    </div>
                                </div>
                                <div class="form-order__input-box">
                                    <div class="form-order__input-title _nessesary">Имя получателя</div>
                                    <div class="input">
                                        <input required autocomplete="off" type="text" name="recipientName"
                                            data-error="Ошибка" placeholder="Введите имя получателя"
                                            class="form-order__input">
                                    </div>
                                </div>
                                <div class="form-order__input-box">
                                    <div class="form-order__input-title _nessesary">Телефон получателя</div>
                                    <div class="input">
                                        <input required data-phone autocomplete="off" type="text" name="recipientTel"
                                            data-error="Ошибка" placeholder="Номер телефона" class="form-order__input">
                                    </div>
                                </div>
                                <div class="form-order__input-box">
                                    <div class="form-order__input-title _nessesary">Ваш e-mail</div>
                                    <div class="input">
                                        <input required autocomplete="off" type="email" name="email" data-error="Ошибка"
                                            placeholder="Ваш e-mail" class="form-order__input">
                                    </div>
                                </div>
                                <div class="form-order__input-box">
                                    <div class="form-order__input-title">Промокод</div>
                                    <div class="input">
                                        <input autocomplete="off" type="text" name="promo" data-error="Ошибка"
                                            placeholder="Промокод" value="{{promo}}" class="form-order__input">
                                    </div>
                                </div>
                            </div>
                            <div class="form-order__input-box ">
                                <div class="form-order__input-title">Подробное содержимое груза</div>
                                <div class="input">
                                    <textarea name="comment" id="" placeholder="Опишите содержимое груза" rows="5"
                                        cols="33"></textarea>
                                </div>
                            </div>
                            <div class="form-order__input-box _margin-10">
                                <div class="form-order__input-title">Инструкция для курьера</div>
                                <div class="input">
                                    <textarea name="instruction" id="" placeholder="Инструкция" rows="5"
                                        cols="33"></textarea>
                                </div>
                            </div>
                            <div class="form-order__input-box _margin-10">
                                <div class="form-order__input-title">Удобно ли вам распечатать накладную?</div>
                                <div class="form-order__checkbox checkbox">
                                    <input checked type="radio" class="checkbox__input active" id="answer_yes"
                                        name="print" value="True">
                                    <label class="form-order__label checkbox__label" for="answer_yes">
                                        <span></span>
                                        <span class="checkbox__text">Да</span>
                                    </label>
                                    <input type="radio" class="checkbox__input " id="answer_no" name="print"
                                        value="False">
                                    <label class="form-order__label checkbox__label" for="answer_no">
                                        <span></span>
                                        <span class="checkbox__text">Нет</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="form-order__section">
                            <div class="form-order__danger">
                                Нажимая на кнопку вы соглашаетесь с условиями отправки и принимаете <a
                                    href="/oferta">оферту</a> и
                                <a href="/privacy">политику</a> конфиденциальности
                            </div>
                            <div class="form-order__price">
                                К оплате: <span>{{price}}</span> ₸
                            </div>
                            <div class="form-order__submit-box buttons-box">
                                <a href="/" class="form-order__cancel button cancel">Отмена</a>
                                <button data-btncalc type="submit" class="form-order__submit button submit"> Перейти к
                                    оплате
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

    </section>
    {% else %}
    <div style="color:red; text-align: center; padding: 10% 0; text-transform: uppercase; font-size: 40px;">
        {{ errorText}}
    </div>
    {% endif %}
</main>
{% block popup %}
<div id="popup_success" aria-hidden="true" class="popup">
    <div class="popup__wrapper">
        <div class="popup__content">
            <button data-close type="button" class="popup__close"></button>
            <div class="popup__header">
                <div class="popup__circle">
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <div class="popup__title">Заявка оформлена </div>
                <div class="popup__text">
                    В течении 10 минут вам на почту придёт письмо с трек-номером
                    для отслеживания заказа и накладная по Вашему отправлению, ее нужно распечатать и передать
                    курьеру
                    вместе с Вашей посылкой
                </div>
            </div>
            <a href="/" class="popup__button button">Вернуться на главную</a>
        </div>
    </div>
</div>
{% endblock %}

<script>
    
    async function calculatePriceOrder(form) {
        let deliveryPrice, deliveryDate, data = {
            type: "",
            from: "",
            where: "",
            from_country: "",
            where_country: "",
            date: "",
            weight: "",
            heightbox: "",
            lengthbox: "",
            widthbox: "",
            postIndexSender: "",
            postIndexRecipient: "",
            promo: ""
        };
        form.querySelectorAll('input[type="radio"]').forEach((radio => {
            if (radio.checked && "document" == radio.value) {
                data.type = 'document';
                const from = form.querySelector('[name="from"]'),
                from_country = form.querySelector('[name="from_country"]'), 
                where = form.querySelector('[name="where"]'), 
                where_country = form.querySelector('[name="where_country"]'), 
                weight = form.querySelector('[name="weight"]'), 
                promo = form.querySelector('[name="promo"]'), 
                dataSend = form.querySelector('[name="dataSend"]'), 
                postIndexSender = form.querySelector('[name="postIndexSender"]'), 
                postIndexRecipient = form.querySelector('[name="postIndexRecipient"]');
                data.from = from.value;
                data.where = where.value;
                data.from_country = from_country.value;
                data.date = dataSend.value;
                data.where_country = where_country.value;
                data.weight = parseFloat(weight.value);
                data.postIndexSender = postIndexSender.value;
                data.postIndexRecipient = postIndexRecipient.value;
                data.promo = promo.value;
            } else if (radio.checked && "package" == radio.value) {
                data.type = 'package';
                const from = form.querySelector('[name="from"]'),
                from_country = form.querySelector('[name="from_country"]'), 
                where_country = form.querySelector('[name="where_country"]'), 
                where = form.querySelector('[name="where"]'), 
                height = form.querySelector('[name="height"]'), 
                length = form.querySelector('[name="length"]'), 
                promo = form.querySelector('[name="promo"]'), 
                width = form.querySelector('[name="width"]'), 
                weight = form.querySelector('[name="weight"]'), 
                dataSend = form.querySelector('[name="dataSend"]'), 
                postIndexSender = form.querySelector('[name="postIndexSender"]'), 
                postIndexRecipient = form.querySelector('[name="postIndexRecipient"]');
                data.from = from.value;
                data.where = where.value;
                data.weight = parseFloat(weight.value);
                data.from_country = from_country.value;
                data.where_country = where_country.value;
                data.date = dataSend.value;
                data.heightbox = height.value;
                data.lengthbox = length.value;
                data.widthbox = width.value;
                data.postIndexSender = postIndexSender.value;
                data.postIndexRecipient = postIndexRecipient.value;
                data.promo = promo.value;
            }
        }));
        let response = await fetch("/order/tariff/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json;charset=utf-8"
            },
            body: JSON.stringify(data)
        });

        const isPrint = form.querySelector('input[name="print"]:checked')
        
        if(isPrint.value.toString() === "True"){
            document.querySelector('.form-order__danger').insertAdjacentHTML('beforeBegin', `
                <div class="form-order__danger">
                    Накладная будет отправлена на Вашу почту после оформления заказа, ее нужно будет распечатать и передать курьеру вместе с Вашей посылкой
                </div>
            `)
        }
        else {
            document.querySelector('[name="instruction"]').value = `
                Принести с собой накладную
            `
        }
        let result = await response.json();
        
        let percent = ''
        if(result['DlvyDateTime'] != '')
        form.querySelector(".form-order__price").insertAdjacentHTML("beforeBegin", `<h2 style="color: #23262f; margin-bottom: 10px;">Ориентировочная дата доставки: ${result['DlvyDateTime']}</h2>`);

        if (result['percent'] > -1 && result['percent'] != 0) {
            percent = `<div class="first-screen-calc__promo">Скидка: ${result['percent']}%</div>`
            form.querySelector(".form-order__price").insertAdjacentHTML("afterBegin", percent);

        }
        if (!result["error"]) return result;

        else {
            const errorMsg = `<span class='errorMsg' style = 'color: red; padding: 1rem 0'>${result['errorText']}</span>`
            if (!form.querySelector('.errorMsg'))
                form.querySelector("[data-btncalc]").insertAdjacentHTML("afterEnd", errorMsg);
            else {
                form.querySelector('.errorMsg').remove()
                form.querySelector("[data-btncalc]").insertAdjacentHTML("afterEnd", errorMsg);
            }
            return false;
        }
    }
    const orderForm = document.querySelector('.order__form')
    const buttonSubmit = orderForm.querySelector('.form-order__submit')
    const priceLabel = orderForm.querySelector('.form-order__price')
    const priceText = priceLabel.innerHTML
    let isCalculated = false
    priceLabel.innerHTML = ''
    buttonSubmit.innerHTML = 'Расчитать'
    orderForm.addEventListener('submit', (event) => {
        if (!isCalculated) {
            event.preventDefault()
            calculatePriceOrder(orderForm).then(price => {
                if (price["price"]) {
                    priceLabel.innerHTML = priceText + priceLabel.innerHTML
                    if(price["oldPrice"] !== price["price"])
                    priceLabel.querySelector('span').innerHTML = `
                    <span style = "text-decoration: line-through;">${price["oldPrice"]}</span>
                    <span>${price["price"]}</span>
                    `
                    else
                    priceLabel.querySelector('span').innerHTML = `
                    <span>${price["price"]}</span>
                    `
                    buttonSubmit.innerHTML = 'Оплатить'
                    isCalculated = true
                }

            })
        }
    })


</script>
{% endblock %}